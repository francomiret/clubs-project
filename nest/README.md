# üèÜ Clubs Project - Sistema de Gesti√≥n Deportiva

## üìã Descripci√≥n General

Sistema completo de gesti√≥n de clubs deportivos construido con **NestJS**, **Prisma ORM** y **PostgreSQL**, implementando autenticaci√≥n JWT, sistema de roles y permisos granular, paginaci√≥n, manejo de errores centralizado y documentaci√≥n completa con Swagger.

## üöÄ Configuraci√≥n R√°pida

### 1. Iniciar la base de datos

```bash
docker-compose up -d
```

### 2. Instalar dependencias

```bash
npm install
```

### 3. Aplicar migraciones

```bash
npm run db:migrate
```

### 4. Poblar la base de datos con datos de ejemplo

```bash
npm run db:seed
```

### 5. Iniciar la aplicaci√≥n

```bash
npm run start:dev
```

## üîê Sistema de Autenticaci√≥n y Autorizaci√≥n

### Caracter√≠sticas Principales

- **JWT (JSON Web Tokens)** para autenticaci√≥n
- **Refresh tokens** para renovaci√≥n autom√°tica
- **Sistema de roles** espec√≠ficos por club
- **Permisos granulares** para control de acceso
- **Guards de protecci√≥n** para rutas sensibles

### Variables de Entorno

Crear archivo `.env` en la ra√≠z:

```env
# Database
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/clubs_db?schema=public"

# JWT Configuration
JWT_SECRET="your-super-secret-jwt-key-here"
JWT_REFRESH_SECRET="your-super-secret-refresh-key-here"
JWT_EXPIRES_IN="1h"
JWT_REFRESH_EXPIRES_IN="7d"

# Application
PORT=3001
NODE_ENV=development
FRONTEND_URL=http://localhost:3000
```

### Endpoints de Autenticaci√≥n

#### 1. Registro de Usuario

**POST** `/auth/register`

```json
{
  "email": "user@example.com",
  "password": "password123",
  "name": "Juan P√©rez",
  "clubName": "Club Deportivo"
}
```

#### 2. Login

**POST** `/auth/login`

```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

#### 3. Refresh Token

**POST** `/auth/refresh`

```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

#### 4. Perfil de Usuario

**GET** `/auth/profile`

```
Authorization: Bearer <token>
```

#### 5. Logout

**POST** `/auth/logout`

```
Authorization: Bearer <token>
```

## üõ°Ô∏è Sistema de Roles y Permisos

### Modelo de Datos

- **Club**: Entidad principal que contiene la informaci√≥n del club
- **User**: Usuarios del sistema
- **UserClub**: Relaci√≥n muchos a muchos entre usuarios y clubs con roles
- **Role**: Roles espec√≠ficos por club
- **Permission**: Permisos del sistema
- **RolePermission**: Relaci√≥n entre roles y permisos
- **Member**: Miembros del club
- **Sponsor**: Patrocinadores del club
- **Payment**: Pagos realizados

### Permisos Disponibles (35 total)

#### Usuarios

- `users.read`, `users.create`, `users.update`, `users.delete`

#### Miembros

- `members.read`, `members.create`, `members.update`, `members.delete`

#### Sponsors

- `sponsors.read`, `sponsors.create`, `sponsors.update`, `sponsors.delete`

#### Pagos

- `payments.read`, `payments.create`, `payments.update`, `payments.delete`

#### Roles

- `roles.read`, `roles.create`, `roles.update`, `roles.delete`

#### Permisos

- `permissions.read`, `permissions.create`, `permissions.update`, `permissions.delete`

#### Clubs

- `club.read`, `club.update`, `clubs.read`

#### Propiedades

- `properties.read`, `properties.create`, `properties.update`, `properties.delete`

#### Actividades

- `activities.read`, `activities.create`, `activities.update`, `activities.delete`

### Roles Predefinidos

#### ADMIN

- **Permisos**: Todos los permisos disponibles
- **Acceso**: Gesti√≥n completa del sistema

#### MANAGER

- **Permisos**: Todos excepto eliminaci√≥n y gesti√≥n de roles/permisos
- **Acceso**: Gesti√≥n de datos sin eliminaci√≥n

#### MEMBER

- **Permisos**: Solo permisos de lectura
- **Acceso**: Visualizaci√≥n de informaci√≥n

### Uso del Sistema

#### Guard de Permisos

```typescript
@UseGuards(JwtAuthGuard, PermissionsGuard)
@Controller('users')
export class UsersController {
  @Get()
  @RequirePermissions('users.read')
  findAll() {
    return this.usersService.findAll();
  }
}
```

#### Decorador de Permisos

```typescript
@RequirePermissions('users.create', 'users.update')
create(@Body() createUserDto: CreateUserDto) {
  return this.usersService.create(createUserDto);
}
```

## üìä Sistema de Paginaci√≥n

### Uso R√°pido

#### En el Controlador

```typescript
@Get('paginated')
@Paginated()
@ApiOperation({ summary: 'Obtener elementos con paginaci√≥n' })
findAllPaginated(@Query() query: PaginationQueryDto) {
  return this.exampleService.findAllPaginated(query);
}
```

#### Par√°metros de Query

- `page` (opcional): N√∫mero de p√°gina (default: 1)
- `limit` (opcional): Elementos por p√°gina (default: 10, m√°ximo: 100)

#### Ejemplos de URLs

```
GET /clubs/paginated                    # P√°gina 1, 10 elementos
GET /clubs/paginated?page=2             # P√°gina 2, 10 elementos
GET /clubs/paginated?limit=5            # P√°gina 1, 5 elementos
GET /clubs/paginated?page=3&limit=20    # P√°gina 3, 20 elementos
```

#### Respuesta de Paginaci√≥n

```json
{
  "data": [...],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 25,
    "totalPages": 3,
    "hasNext": true,
    "hasPrev": false
  }
}
```

## üõ°Ô∏è Sistema de Manejo de Errores

### Componentes Principales

1. **HttpExceptionFilter** - Filtro global de excepciones
2. **LoggingInterceptor** - Interceptor para logging de requests/responses
3. **TransformInterceptor** - Interceptor para transformar respuestas
4. **RequestIdMiddleware** - Middleware para tracking de requests
5. **Excepciones Personalizadas** - Clases de excepci√≥n espec√≠ficas

### Estructura de Respuestas

#### Respuesta Exitosa

```json
{
  "success": true,
  "data": { ... },
  "timestamp": "2025-08-01T10:30:00.000Z",
  "path": "/api/clubs",
  "requestId": "req_1733123400000_abc123def"
}
```

#### Respuesta de Error

```json
{
  "statusCode": 404,
  "message": "Club con ID 123 no encontrado",
  "error": "EntityNotFoundException",
  "timestamp": "2025-08-01T10:30:00.000Z",
  "path": "/api/clubs/123",
  "requestId": "req_1733123400000_abc123def"
}
```

### Tipos de Errores Manejados

- **400**: Errores de validaci√≥n
- **401**: Token JWT inv√°lido o expirado
- **403**: Usuario no tiene permisos requeridos
- **404**: Recurso no encontrado
- **409**: Conflicto (recurso ya existe)
- **500**: Error interno del servidor

## üåê Endpoints Disponibles

### Autenticaci√≥n

- `POST /auth/login` - Iniciar sesi√≥n
- `POST /auth/register` - Registrarse
- `POST /auth/refresh` - Renovar token
- `GET /auth/profile` - Obtener perfil
- `POST /auth/logout` - Cerrar sesi√≥n

### Permisos

- `GET /permissions` - Listar permisos
- `GET /permissions/paginated` - Listar con paginaci√≥n
- `POST /permissions` - Crear permiso
- `GET /permissions/:id` - Obtener permiso
- `PATCH /permissions/:id` - Actualizar permiso
- `DELETE /permissions/:id` - Eliminar permiso

### Roles

- `GET /roles` - Listar roles
- `GET /roles/paginated` - Listar con paginaci√≥n
- `GET /roles/club/:clubId` - Roles por club
- `POST /roles` - Crear rol
- `GET /roles/:id` - Obtener rol
- `PATCH /roles/:id` - Actualizar rol
- `DELETE /roles/:id` - Eliminar rol
- `POST /roles/assign-user` - Asignar usuario a rol

### Otros M√≥dulos

- **Clubs**: `/clubs`
- **Users**: `/users`
- **Members**: `/members`
- **Sponsors**: `/sponsors`
- **Payments**: `/payments`

## üìö Documentaci√≥n de la API (Swagger)

### Acceso a la Documentaci√≥n

Una vez que la aplicaci√≥n est√© ejecut√°ndose, accede a la documentaci√≥n interactiva en:

```
http://localhost:3001/api
```

### Caracter√≠sticas

- **Documentaci√≥n Autom√°tica**: Todos los endpoints documentados autom√°ticamente
- **Validaci√≥n de DTOs**: Los DTOs incluyen validaciones y ejemplos
- **Respuestas Tipadas**: Todas las respuestas est√°n tipadas con entidades
- **Interfaz Interactiva**: Puedes probar los endpoints directamente desde Swagger UI
- **Organizaci√≥n por Tags**: Los endpoints est√°n organizados por categor√≠as

## üèóÔ∏è Arquitectura del Proyecto

### Patr√≥n Repository

Este proyecto implementa el patr√≥n Repository para mejorar la separaci√≥n de responsabilidades y facilitar el testing.

#### Componentes del Patr√≥n Repository:

1. **Interfaz del Repositorio** (`IClubsRepository`):
   - Define el contrato para todas las operaciones de datos
   - M√©todos para CRUD b√°sico y operaciones con relaciones

2. **Implementaci√≥n del Repositorio** (`ClubsRepository`):
   - Implementa la interfaz usando Prisma
   - Maneja todas las operaciones de base de datos
   - Incluye m√©todos para obtener datos con relaciones

3. **Token de Inyecci√≥n** (`CLUBS_REPOSITORY`):
   - Permite la inyecci√≥n de dependencias con la interfaz
   - Facilita el testing y la flexibilidad

4. **Servicio** (`ClubsService`):
   - Usa el repositorio a trav√©s de la interfaz
   - Separaci√≥n clara de responsabilidades
   - L√≥gica de negocio independiente del acceso a datos

### Flujo de Datos

```
HTTP Request ‚Üí Controller ‚Üí Service ‚Üí Repository ‚Üí Database
                ‚Üì           ‚Üì         ‚Üì
              DTOs      Business    Data Access
                        Logic       Layer
```

## üìÅ Estructura del Proyecto

```
src/
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ prisma.service.ts    # Servicio de conexi√≥n a BD
‚îÇ   ‚îî‚îÄ‚îÄ prisma.module.ts     # M√≥dulo global de Prisma
‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îú‚îÄ‚îÄ dto/                 # DTOs compartidos
‚îÇ   ‚îú‚îÄ‚îÄ services/            # Servicios compartidos
‚îÇ   ‚îú‚îÄ‚îÄ interceptors/        # Interceptores globales
‚îÇ   ‚îú‚îÄ‚îÄ filters/             # Filtros de excepciones
‚îÇ   ‚îú‚îÄ‚îÄ guards/              # Guards de autenticaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ decorators/          # Decoradores personalizados
‚îÇ   ‚îî‚îÄ‚îÄ middleware/          # Middleware global
‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îú‚îÄ‚îÄ dto/                 # DTOs de autenticaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ entities/            # Entidades de autenticaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ strategies/          # Estrategias de Passport
‚îÇ   ‚îú‚îÄ‚îÄ guards/              # Guards de autenticaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ decorators/          # Decoradores de auth
‚îÇ   ‚îú‚îÄ‚îÄ interfaces/          # Interfaces JWT
‚îÇ   ‚îú‚îÄ‚îÄ auth.service.ts      # Servicio de autenticaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ auth.controller.ts   # Controlador de auth
‚îÇ   ‚îî‚îÄ‚îÄ auth.module.ts       # M√≥dulo de autenticaci√≥n
‚îú‚îÄ‚îÄ clubs/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îú‚îÄ‚îÄ clubs.repository.ts  # Patr√≥n Repository
‚îÇ   ‚îú‚îÄ‚îÄ clubs.service.ts     # L√≥gica de negocio
‚îÇ   ‚îú‚îÄ‚îÄ clubs.controller.ts  # Controlador HTTP
‚îÇ   ‚îî‚îÄ‚îÄ clubs.module.ts      # M√≥dulo de clubs
‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îú‚îÄ‚îÄ users.repository.ts
‚îÇ   ‚îú‚îÄ‚îÄ users.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ users.controller.ts
‚îÇ   ‚îî‚îÄ‚îÄ users.module.ts
‚îú‚îÄ‚îÄ members/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îú‚îÄ‚îÄ members.repository.ts
‚îÇ   ‚îú‚îÄ‚îÄ members.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ members.controller.ts
‚îÇ   ‚îî‚îÄ‚îÄ members.module.ts
‚îú‚îÄ‚îÄ sponsors/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îú‚îÄ‚îÄ sponsors.repository.ts
‚îÇ   ‚îú‚îÄ‚îÄ sponsors.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ sponsors.controller.ts
‚îÇ   ‚îî‚îÄ‚îÄ sponsors.module.ts
‚îú‚îÄ‚îÄ payments/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îú‚îÄ‚îÄ payments.repository.ts
‚îÇ   ‚îú‚îÄ‚îÄ payments.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ payments.controller.ts
‚îÇ   ‚îî‚îÄ‚îÄ payments.module.ts
‚îú‚îÄ‚îÄ roles/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îú‚îÄ‚îÄ roles.repository.ts
‚îÇ   ‚îú‚îÄ‚îÄ roles.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ roles.controller.ts
‚îÇ   ‚îî‚îÄ‚îÄ roles.module.ts
‚îú‚îÄ‚îÄ permissions/
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îú‚îÄ‚îÄ permissions.repository.ts
‚îÇ   ‚îú‚îÄ‚îÄ permissions.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ permissions.controller.ts
‚îÇ   ‚îî‚îÄ‚îÄ permissions.module.ts
‚îú‚îÄ‚îÄ swagger.config.ts        # Configuraci√≥n de Swagger
‚îú‚îÄ‚îÄ swagger-ui.config.ts     # Configuraci√≥n de UI de Swagger
‚îî‚îÄ‚îÄ app.module.ts            # M√≥dulo principal
```

## üõ†Ô∏è Comandos √ötiles

```bash
# Base de datos
npm run db:studio      # Abrir Prisma Studio
npm run db:migrate     # Aplicar migraciones
npm run db:generate    # Generar cliente Prisma
npm run db:reset       # Resetear base de datos
npm run db:seed        # Poblar con datos de ejemplo

# Desarrollo
npm run start:dev      # Iniciar en modo desarrollo
npm run build          # Compilar el proyecto
npm run test           # Ejecutar tests
```

## üß™ Datos de Prueba

### Usuario Administrador por Defecto

- **Email**: `admin@club.com`
- **Password**: `admin123`
- **Rol**: ADMIN
- **Permisos**: Todos los permisos del sistema (35)

### Datos Creados por el Seed

- **35 permisos** del sistema
- **1 club** por defecto
- **1 rol ADMIN** con todos los permisos
- **1 usuario admin** con acceso completo

## üîí Seguridad

### Autenticaci√≥n

- **JWT tokens** con expiraci√≥n configurable
- **Refresh tokens** para renovaci√≥n autom√°tica
- **Encriptaci√≥n de contrase√±as** con bcrypt

### Autorizaci√≥n

- **Sistema de permisos granular** por recurso y acci√≥n
- **Roles espec√≠ficos por club** para multi-tenancy
- **Validaci√≥n de permisos** en cada endpoint

### Validaci√≥n

- **Validaci√≥n global** con class-validator
- **Sanitizaci√≥n de datos** en logs
- **Manejo seguro de errores** sin exposici√≥n de informaci√≥n interna

## üöÄ Pr√≥ximos Pasos

### Funcionalidades Planificadas

1. **Cache de permisos** para mejorar rendimiento
2. **Logs de auditor√≠a** para cambios en roles y permisos
3. **Permisos condicionales** basados en datos
4. **Roles temporales** con fechas de expiraci√≥n
5. **Interfaz de administraci√≥n web** para gesti√≥n de roles

### Mejoras de Seguridad

1. **Blacklist de tokens** para logout seguro
2. **Rate limiting** para prevenir ataques de fuerza bruta
3. **Two-factor authentication** (2FA)
4. **OAuth integration** con Google, Facebook, etc.

### Mejoras de Performance

1. **Cache Redis** para datos frecuentemente accedidos
2. **Compresi√≥n de respuestas** para reducir ancho de banda
3. **Lazy loading** de relaciones en Prisma
4. **Connection pooling** optimizado para PostgreSQL

## üîç Verificaci√≥n del Sistema

### 1. Verificar Base de Datos

```bash
npm run db:seed
```

### 2. Iniciar Aplicaci√≥n

```bash
npm run start:dev
```

### 3. Verificar Documentaci√≥n

- Abrir navegador en: `http://localhost:3001/api`
- Deber√≠as ver la interfaz de Swagger con todos los endpoints

### 4. Probar Autenticaci√≥n

- Usar credenciales: `admin@club.com` / `admin123`
- Verificar que puedes acceder a `/permissions`, `/roles`, `/users`

## üìû Soporte y Contacto

### Documentaci√≥n Adicional

- **Swagger UI**: `http://localhost:3001/api`
- **Prisma Studio**: `npm run db:studio`

### Soluci√≥n de Problemas Comunes

#### Error de Conexi√≥n a Base de Datos

```bash
# Verificar que PostgreSQL est√© corriendo
docker ps
# Verificar DATABASE_URL en .env
```

#### Error de Compilaci√≥n

```bash
# Limpiar cache
rm -rf node_modules
npm install
npm run build
```

#### Error de Seed

```bash
# Verificar esquema de base de datos
npx prisma db push
npm run db:seed
```

---

## üéâ ¬°El sistema est√° completamente implementado y listo para usar!

**Caracter√≠sticas implementadas:**

- ‚úÖ Autenticaci√≥n JWT completa
- ‚úÖ Sistema de roles y permisos granular
- ‚úÖ Paginaci√≥n autom√°tica
- ‚úÖ Manejo de errores centralizado
- ‚úÖ Documentaci√≥n Swagger completa
- ‚úÖ Patr√≥n Repository implementado
- ‚úÖ Validaci√≥n global de datos
- ‚úÖ Logging detallado
- ‚úÖ Base de datos configurada y poblada
- ‚úÖ Endpoints protegidos y funcionales

**Para comenzar:**

1. Ejecuta `npm run db:seed` para configurar la base de datos
2. Inicia la aplicaci√≥n con `npm run start:dev`
3. Accede a la documentaci√≥n en `http://localhost:3001/api`
4. Usa las credenciales admin: `admin@club.com` / `admin123`
